# ステータス記録ルールと現状

## ルール
- 目的・進捗・次の一手を随時追記し、次回作業者が迷わないようにする。
- 作業後は「最新状況」と「次回やること」を必ず更新する。
- 大きな方針変更は `docs/bi-mobile-plan.md` とセットで更新する。

## 目的（現状）
- スマホブラウザで営業/CS/マネージャーが主要指標を即座に確認し、通知や共有まで完結できるBIビューを提供する。

## 想定（利用者・利用シーン）
- 営業/CS/マネージャーが移動中や現場で主要指標を即確認し、Slack/メールで共有や通知設定まで完了させる。
- モバイル前提のタップ操作、短時間での情報取得と共有が優先。

## 最新状況（2025-11-29）
- 初期UIはモックデータ前提で配置済み（KPIカード、トレンド、セグメント、クイックアクション）。
- `/` ダッシュボードをモックAPI `/api/dashboard` でフェッチするよう変更。期間（7/30/90日）とセグメント（all/mobile/desktop）を切替可能にし、ローディング・エラー・空状態をUIに追加（`?empty=1` で空状態を再現）。
- 株価カードは `/api/stocks` 経由でクライアント取得（StocksPanel）。読み込み中/エラー表示を追加。
- ダッシュボードUIをリッチ化：クイックアクション（共有/通知）、インサイトリスト、サービス健全性カードを追加し、日本語ラベルに統一。ハブへ戻る導線も配置。
- `/login` をモックAPI `/api/auth/mock` に接続。メール/コードのバリデーション、送信/ログイン時の状態表示を追加（モックでは 123456 で常に成功）。
- `/login` に擬似セッション保存（localStorage）、成功後 `/tools` リダイレクト、自動ハブ遷移、手動ログアウト（セッションクリア）を追加。
- アドホック分析 `/adhoc` をモックAPI `/api/adhoc` と接続し、期間・ディメンション切替、ローディング/エラー/空状態、サマリ＋テーブル表示を追加。
- 共有リンクモック `/api/share` を追加し、ダッシュボードから発行/表示できるようにした。`localStorage` に「最近使った」保存ユーティリティを追加（ハブで利用予定）。
- ハブに「最近使った」表示を追加し、モックアクション（Slack/CSV/アラート）実行時にトースト表示を追加。ダッシュボードも共有リンク発行でトースト表示。
- ダッシュボードのデータ取得をフック化（`useDashboardData`）。フィルタ用 `useFilters` を共通化。モックアクション用 `useMockAction` でトーストを再利用。ハブのモックボタンもこのトーストを使用。
- ツール選択ハブ `/tools` の各カードから遷移可能にし、`/adhoc`（アドホック分析）、`/ops`（運用ヘルス）、`/settings`（設定）にモック画面を追加。
- 開発サーバーは 0.0.0.0:3010 で起動確認済み（ローカル `curl -I http://127.0.0.1:3010/login` が 200 OK、PID 80963）。
- スマホからのアクセスはファイアウォール/VPN設定によるブロックが疑われるため未疎通。macOSファイアウォールで node の受信許可、VPNで「ローカルネットワークを許可」設定が必要。
- 全許可の `trust.json` を設定済み。
- 計画ドキュメント `docs/bi-mobile-plan.md` を作成済み。画面構成に「ログイン → ツール選択（ハブ） → ダッシュボード」の流れを追記。
- トンネル手順（今後用メモ）:  
  1. ローカルで dev 起動 `npm run dev -- --hostname 0.0.0.0 --port 3010`（現在 PID 80976）。  
  2. Cloudflare Quick Tunnel を使用: `cloudflared tunnel --url http://127.0.0.1:3010 --no-autoupdate --protocol http2 --edge-ip-version auto`。  
  3. ログ `/tmp/cloudflared-3010.log` に URL が出力される（**現行URL: `https://wise-reward-steady-feels.trycloudflare.com`**）。Quick Tunnel は毎回URLが変わるため、共有前に必ず最新URLをこのファイルかチャットに記載する。  
  4. 停止は `pkill -f cloudflared`。localtunnel は警告ページが出るため現在は非採用。

## 次回やること（提案）
- SWR/React Query 等でフェッチ/キャッシュ/再検証を整理し、フィルタコンポーネント化＆共通化（ダッシュボード/アドホック）。
- ダッシュボード/アドホックのAPIを期間・セグメント以外のフィルタ（デバイス/チャネル等）にも対応させ、クエリパラメータ連動を強化。
- `/login` にエラーパターン（レートリミット/ロック）、サインアウトのUI、ハブ遷移時のトースト通知を追加。
- グラフ/テーブルにローディングスケルトンを拡充し、空/エラー状態のビジュアルをデザインシステム化。
- 「最近使った」をハブで表示（localStorage）済み。次はフィルタコンポーネント共通化とトースト導入（共有/CSV/Slackモック）を行う。
